---

# Common setup
- hosts: db:nuxeo:https
  gather_facts: yes
  sudo: yes
  roles:
  - {role: common, tags: [ 'https' ] }

# Install packages and download distribution
- hosts: db
  gather_facts: no
  sudo: yes
  roles:
  - {role: db, stage: init}
- hosts: nuxeo
  gather_facts: no
  sudo: yes
  roles:
  - {role: nuxeo, stage: init}

# Prepare for updates
- hosts: nuxeo
  gather_facts: no
  sudo: yes
  roles:
  - {role: nuxeo, stage: stop}
- hosts: db
  gather_facts: no
  sudo: yes
  roles:
  - {role: db, stage: stop}

# Update configuration/data
- hosts: db
  gather_facts: no
  sudo: yes
  roles:
  - {role: db, stage: setup}
- hosts: nuxeo
  gather_facts: no
  sudo: yes
  roles:
  - {role: nuxeo, stage: setup}

# Complete update
- hosts: db
  gather_facts: no
  sudo: yes
  roles:
  - {role: db, stage: start}
- hosts: nuxeo
  gather_facts: no
  sudo: yes
  roles:
  - {role: nuxeo, stage: start}

# Install reverse proxy
- hosts: https
  gather_facts: no
  sudo: yes
  roles:
  - {role: https, tags: [ 'https' ] }
